#!/usr/bin/env bash

set -euo pipefail
trap "echo 'error: Script failed: see failed command above'" ERR

cd "$(dirname "$0")/.."

# ==============================================================================
# npm install
# bundle ? [install]

# [git branch --delete --force gh-pages]
# git checkout --orphan gh-pages
# git rm -r --cached -- .
# git add --force docs/
# git commit --message="Publishing $(git rev-parse --short main) on $(date)"
# git push --force origin gh-pages
# ==============================================================================

# JEKYLL_ENV=production bundle exec jekyll build

npx concurrently --names "jekyll,postcss,prettier" --kill-others \
  'bundle exec jekyll serve --open-url --livereload' \
  'npx postcss styles.css --output _site/styles.css --watch' \
  'npx onchange "**/*.html" "**/*.md" --exclude-path .gitignore -- npx prettier --write {{changed}}' \
|| true
